/*! Copyright 2009-2017 Evernote Corporation. All rights reserved. */

function NotebookSelector(a){"use strict";function b(){return ba.value.trim()}function c(){var a=b();if(a)if(EDGE&&document.activeElement.blur(),fa.disabled=!0,h(!0),d(a))i(Browser.i18n.getMessage("Error_Create_Notebook_ExistingName"));else{var c={name:a};"function"==typeof J&&J(c)}}function d(a){for(var b=a.toLowerCase(),c=0;c<ga.length;c++){var d=ga[c];if(b===d.name.toLowerCase()&&(!d.type||d.type!=GlobalUtils.NOTEBOOK_TYPE_LINKED))return!0}return!1}function e(){ba.placeholder=Browser.i18n.getMessage("createNewNotebook"),ca.classList.add("hide"),ba.value="",fa.disabled=!1,j()}function f(){ca.classList.contains("hide")&&(Browser.sendToExtension({name:"trackEvent",category:"notebooks",action:"add_notebook"}),ba.placeholder=Browser.i18n.getMessage("enterName"),ca.classList.remove("hide"),"function"==typeof setHeight&&setHeight())}function g(a){log.log("Generate notebooks list"),h(!0),"function"==typeof I&&I()}function h(a){a?(N.classList.add("nbLoading"),_.classList.add("rotating")):(N.classList.remove("nbLoading"),_.classList.remove("rotating"))}function i(a){h(!1),X.classList.remove("hide"),Y.innerText=a,"function"==typeof setHeight&&setHeight()}function j(){X.classList.add("hide"),"function"==typeof setHeight&&setHeight()}function k(a){ga.push(a),l(ga)}function l(a){h(!1),ga=a,m()}function m(){var a;ga&&ga.length>0&&(A(),ga.forEach(function(b){o(b),b.defaultNotebook&&(a=b.guid)},this),a=a||ga[0].guid,n(a)),"function"==typeof setHeight&&setHeight()}function n(a){if(a){var b=R.querySelector('.nbNotebook[guid="'+a+'"]');b&&C(b)}else log.warn("Tried to select notebook without guid: "+JSON.stringify(a))}function o(a){var b=document.createElement("div");b.classList.add("nbNotebook");var c=document.createElement("span");c.innerText=a.name;for(var d=a.name.split(/\s+/),e=0;e<d.length;e++)L.insert(d[e],b),CommonSelector.SPECIAL_CHAR_REGEX.test(d[e])&&L.insert(d[e].replace(CommonSelector.SPECIAL_CHAR_REGEX,""),b);if(b.appendChild(c),a.owner){var f=document.createElement("span");f.classList.add("nbNotebookOwner"),f.innerText=" ("+a.owner+")",b.appendChild(f)}return a.type===GlobalUtils.NOTEBOOK_TYPE_LINKED?(b.classList.add("nbLinkedNotebook"),b.setAttribute("globalId",a.globalId),b.setAttribute("shardId",a.shardId),a.noteStoreUrl&&b.setAttribute("noteStoreUrl",encodeURIComponent(a.noteStoreUrl))):a.type===GlobalUtils.NOTEBOOK_TYPE_BUSINESS&&b.classList.add("nbBusinessNotebook"),E(b),x(b)||b.classList.add("nbHidden"),a.noShareNotes&&b.setAttribute("noShareNotes",""),b.addEventListener("click",function(){C(this),ha.userSelectedNotebookGuid=this.getAttribute("guid"),"function"==typeof K&&K(),D()}),b.addEventListener("mouseover",function(){for(var a=R.querySelectorAll(".nbHover"),b=0;b<a.length;b++)a[b].classList.remove("nbHover");this.classList.add("nbHover")}),b.title=b.innerText,b.setAttribute("guid",a.guid),a.defaultNotebook&&b.setAttribute("default",""),w(b,a.stack),b}function p(a){var b=document.createElement("div");b.classList.add("nbStack");var c=document.createElement("h3");return c.innerText=a,c.title=c.innerText,b.appendChild(c),w(b),b}function q(a,b,c,d,e){for(var f=e-1,g=a.toLowerCase();d<=f;){for(var h=d+Math.floor((f-d)/2),i=c[h],j=0;j<(b?b.length:0);j++)i=i[b[j]];if(g<i.innerText.toLowerCase())f=h-1;else{if(!(g>i.innerText.toLowerCase()))return h;d=h+1}}return-1}function r(){return G.classList.contains("nbOpen")}function s(){var a=G.classList.contains("nbOpen");return G.classList.remove("nbOpen"),Q.value="",B(),"function"==typeof H&&H(),a}function t(a){return G.contains(a)}function u(){var a=GlobalUtils.NOTEBOOK_TYPE_PERSONAL;return N.classList.contains("nbSelectedLinked")?a=GlobalUtils.NOTEBOOK_TYPE_LINKED:N.classList.contains("nbSelectedBusiness")&&(a=GlobalUtils.NOTEBOOK_TYPE_BUSINESS),{defaultNotebook:N.hasAttribute("default"),globalId:N.getAttribute("globalId"),guid:N.getAttribute("guid"),name:N.innerText,noteStoreUrl:N.getAttribute("noteStoreUrl"),noShareNotes:N.hasAttribute("noShareNotes"),shardId:N.getAttribute("shardId"),type:a}}function v(a){if(13===a.keyCode){var b=R.querySelector(".nbHover");b&&(C(b),ha.userSelectedNotebookGuid=b.getAttribute("guid"),D())}}function w(a,b){function c(a){return a.classList.contains("nbStack")?a.firstElementChild.innerText:a.classList.contains("nbNotebook")?a.innerText:void 0}var d=R;if(b){var e=R.querySelectorAll(".nbStack");d=e[q(b,["firstElementChild"],e,0,e.length)]||R,d===R&&(d=p(b))}b?CommonSelector.binaryInsert(d,c,a,1):CommonSelector.binaryInsert(d,c,a)}function x(a){for(var b=0;b<M.length;b++)if(M[b].indexOf(a)<0)return!1;return!0}function y(a){function b(a,c){var d=a[c];return d&&d.classList.contains("nbStack")?d="nextElementSibling"===c?d.children[1]:d.lastElementChild:d&&d.parentNode.classList.contains("nbStack")&&d===d.parentNode.children[0]?d=b(d.parentNode,c):!d&&a.parentNode.classList.contains("nbStack")&&(d=b(a.parentNode,c)),d}if(38===a.keyCode||40===a.keyCode){var c=38===a.keyCode?"previousElementSibling":"nextElementSibling",d=R.querySelector(".nbHover")||F;if(d){for(var e=b(d,c);e&&e.classList.contains("nbHidden");)e=b(e,c);e&&!e.classList.contains("nbHidden")&&(d.classList.remove("nbHover"),e.classList.add("nbHover"),e.scrollIntoViewIfNeeded?e.scrollIntoViewIfNeeded():e.scrollIntoView())}a.preventDefault()}}function z(){G.classList.add("nbOpen"),Q.focus(),setTimeout(function(){F&&(F.scrollIntoViewIfNeeded?F.scrollIntoViewIfNeeded():F.scrollIntoView())},50),"function"==typeof H&&H()}function A(){F=null,L=new Tree,M=[],Q.value="",R.innerHTML="",j()}function B(){for(var a=R.querySelectorAll(".nbNotebook.nbHover"),b=0;b<a.length;b++)a[b].classList.remove("nbHover");var c=Q.value.trim();if(c){c=c.split(/\s+/),M=[];for(var b=0;b<c.length;b++){for(var d=L.getMatching(c[b]),e=[],f=0;f<d.length;f++)e=e.concat(d[f][1]);M.push(e)}for(var g=R.querySelectorAll(".nbNotebook"),b=0;b<g.length;b++)x(g[b])?g[b].classList.remove("nbHidden"):g[b].classList.add("nbHidden");R.classList.add("nbSearchOn");var h=R.querySelector(".nbNotebook:not(.nbHidden)");h&&h.classList.add("nbHover")}else{for(var i=R.querySelectorAll(".nbHidden"),b=0;b<i.length;b++)i[b].classList.remove("nbHidden");R.classList.remove("nbSearchOn")}}function C(a){F&&F.classList.remove("nbSelectedNotebook"),a.classList.add("nbSelectedNotebook"),F=a,N.innerText=a.innerText,N.title=N.innerText,N.setAttribute("guid",F.getAttribute("guid")),F.classList.contains("nbBusinessNotebook")?(N.classList.remove("nbSelectedLinked"),N.classList.add("nbSelectedBusiness"),N.removeAttribute("globalId"),N.removeAttribute("shardId"),N.removeAttribute("noteStoreUrl")):F.classList.contains("nbLinkedNotebook")?(N.classList.remove("nbSelectedBusiness"),N.classList.add("nbSelectedLinked"),N.setAttribute("globalId",F.getAttribute("globalId")),N.setAttribute("shardId",F.getAttribute("shardId")),N.setAttribute("noteStoreUrl",F.getAttribute("noteStoreUrl"))):(N.classList.remove("nbSelectedBusiness"),N.classList.remove("nbSelectedLinked"),N.removeAttribute("globalId"),N.removeAttribute("shardId"),N.removeAttribute("noteStoreUrl")),F.hasAttribute("noShareNotes")?N.setAttribute("noShareNotes",""):N.removeAttribute("noShareNotes"),F.hasAttribute("default")?N.setAttribute("default",""):N.removeAttribute("default")}function D(){G.classList.contains("nbOpen")?(e(),s()):z(),"function"==typeof setHeight&&setHeight(!0)}function E(a){var b=Q.value.trim();if(b){b=b.split(/\s+/);for(var c=0;c<b.length;c++)new RegExp("(?:\\s|^)"+b[c],"i").test(a.firstElementChild.innerText)&&(M[c]||M.push([]),M[c].push(a))}}var F,G=a.container,H=a.dropdownToggleCallback,I=a.refreshNotebooksCallback,J=a.createNotebookCallback,K=a.selectNotebookCallback,L=new Tree,M=[],N=document.createElement("div"),O=document.createElement("div"),P=document.createElement("div"),Q=document.createElement("input"),R=document.createElement("div"),S=document.createElement("div"),T=document.createElement("div"),U=document.createElement("hr"),V=document.createElement("span"),W=document.createElement("span"),X=document.createElement("div"),Y=document.createElement("div"),Z=document.createElement("div"),$=document.createElement("span"),_=document.createElement("div"),aa=document.createElement("div"),ba=document.createElement("input"),ca=document.createElement("div"),da=document.createElement("div"),ea=document.createElement("button"),fa=document.createElement("button"),ga=[],ha={userSelectedNotebookGuid:null,optionSelectedNotebookGuid:null};G.classList.add("nbContainer"),N.classList.add("nbSelected"),O.classList.add("nbDropdown"),Q.classList.add("nbSearchInput"),T.classList.add("nbRefreshNotebooksInfoBlock"),U.classList.add("nbRefreshNotebooksLine"),V.classList.add("nbRefreshNotebooksInfo"),X.classList.add("nbGlobalErrorBlock"),X.classList.add("hide"),Y.classList.add("globalErrorBlockInfo"),_.classList.add("nbRefreshNotebooksInfoBlockIcon"),_.classList.add("useSvg"),W.classList.add("nbRefreshNotebooksRefresh"),Z.classList.add("notebooksErrorBlock"),Z.classList.add("hide"),R.classList.add("nbList"),S.classList.add("nbInputFocuser"),aa.classList.add("nbAddNotebookBlock"),ba.classList.add("nbCreateNewNotebookInput"),ba.classList.add("useSvg"),ba.placeholder=Browser.i18n.getMessage("createNewNotebook"),ca.classList.add("nbCreateNewNotebookElementsBlock"),ca.classList.add("hide"),da.classList.add("nbCreateNewNotebookButtons"),ea.classList.add("nbCreateNewNotebookCancelButton"),fa.classList.add("nbCreateNewNotebookCreateButton"),Q.placeholder=Browser.i18n.getMessage("findANotebook"),Q.tabIndex=2,S.tabIndex=1,V.innerHTML=Browser.i18n.getMessage("cantFindIt"),W.innerHTML=Browser.i18n.getMessage("refreshList"),T.appendChild(U),T.appendChild(V),T.appendChild(_),T.appendChild(W),X.appendChild(Y),Z.appendChild($),ea.innerHTML=Browser.i18n.getMessage("regForm_cancel"),fa.innerHTML=Browser.i18n.getMessage("create"),G.appendChild(X),G.appendChild(N),P.appendChild(Q),P.appendChild(Z),P.appendChild(aa),aa.appendChild(ba),aa.appendChild(ca),ca.appendChild(da),da.appendChild(ea),da.appendChild(fa),O.appendChild(P),O.appendChild(R),O.appendChild(T),G.appendChild(O),G.appendChild(S),W.addEventListener("click",function(a){a.stopPropagation(),log.log("Refresh notebooks list"),Browser.sendToExtension({name:"trackEvent",category:"notebooks",action:"refresh"}),g(),Q.focus()}),X.addEventListener("click",function(a){a.stopPropagation(),log.log("Refresh notebooks list"),X.classList.add("hide"),g(),Q.focus()}),ba.addEventListener("focus",function(a){a.stopPropagation(),f()}),ba.addEventListener("click",function(a){a.stopPropagation()}),ba.addEventListener("keyup",function(a){a.stopPropagation(),a.preventDefault(),13===a.keyCode&&c()}),ea.addEventListener("click",function(a){a.stopPropagation(),e()}),fa.addEventListener("click",function(a){c(),a.stopPropagation()}),N.addEventListener("click",function(a){D(),a.stopPropagation()}),Q.addEventListener("click",function(a){a.stopPropagation(),e()}),Q.addEventListener("input",function(){B(),"function"==typeof setHeight&&setHeight()}),Q.addEventListener("keydown",y),Q.addEventListener("keyup",v),S.addEventListener("focus",z),R.addEventListener("mousewheel",Browser.overrideScroll,!0),h(!0),this.getCreateNewNotebookValue=b,this.setNotebooks=l,this.appendNotebook=k,this.saveNewNotebook=c,this.close=s,this.contains=t,this.getSelectedNotebook=u,this.selectNotebook=n,this.open=z,this.reset=A,this.setLoadingStatus=h,this.select=C,this.isOpened=r,this.showError=i,this.closeNewNotebookBlock=e,this.selectionData=ha,this.__defineGetter__("height",function(){return O.offsetTop+O.offsetHeight}),Object.preventExtensions(this)}Object.preventExtensions(NotebookSelector);