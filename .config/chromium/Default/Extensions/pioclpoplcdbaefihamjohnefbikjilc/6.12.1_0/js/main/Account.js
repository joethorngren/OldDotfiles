/*! Copyright 2009-2017 Evernote Corporation. All rights reserved. */

!function(){function a(a){this._onUpdated=a&&"function"==typeof a.onUpdated?a.onUpdated:null,this.host=a.host||"",this.userStore=a.userStore,this.saveUserInfo=a.saveUserInfo,this._userInfo=a.userInfo||null,this._isBusinessAuthenticationRequired=!1,this._accountIsOffline=!1}var b=function(a){if("object"!=typeof a||!a.id)return null;var b={authenticationToken:"",userId:a.id.toString(),username:a.username,basic:a.serviceLevel===ServiceLevel.BASIC,plus:a.serviceLevel===ServiceLevel.PLUS,premium:a.serviceLevel===ServiceLevel.PREMIUM,isOnlyBusiness:4===a.serviceLevel,shardId:a.shardId,fullName:a.name||a.username,email:a.email,quota:a.accountLimits.uploadLimit,noteSizeMax:a.accountLimits.noteSizeMax,userNoteCountMax:a.accountLimits.userNoteCountMax,monthEnd:a.accounting.uploadLimitEnd,photoUrl:a.photoUrl,urls:null,created:a.created,serviceLevel:a.serviceLevel};return Object.defineProperty(b,"id",{get:function(){throw new Error("Incorrect propery access id")}}),a.businessUserInfo&&(b.businessId=a.businessUserInfo.businessId,b.businessName=a.businessUserInfo.businessName),b.isOnlyBusiness?b.accountType=GlobalUtils.ACCOUNT_TYPE_ONLY_BUSINESS:a.businessUserInfo?b.accountType=GlobalUtils.ACCOUNT_TYPE_BUSINESS:b.accountType=GlobalUtils.ACCOUNT_TYPE_PERSONAL,b},c=function(a){return"object"==typeof a&&a.authenticationToken?{bizAuthenticationToken:a.authenticationToken,bizExpiration:a.expiration,bizUrls:JSON.parse(JSON.stringify(a.urls)),bizShardId:a.user.shardId,bizUserId:a.user.id,bizUserName:a.user.username,bizQuota:a.user.accountLimits.uploadLimit,bizNoteSizeMax:a.user.accountLimits.noteSizeMax,bizUserNoteCountMax:a.user.accountLimits.userNoteCountMax,bizMonthEnd:a.user.accounting.uploadLimitEnd}:null},d=function(a,b,c){return new Promise(function(d,e){a[b](c,d,e)})};window.Account=a,Object.defineProperty(a.prototype,"isAuthenticated",{get:function(){return!!this.userInfo.userId}}),Object.defineProperty(a.prototype,"isBusinessAuthenticationRequired",{get:function(){return!!this._isBusinessAuthenticationRequired}}),Object.defineProperty(a.prototype,"userInfo",{get:function(){return this._userInfo||{}},set:function(a){"object"==typeof a?(this._userInfo=a,this.saveUserInfo&&"function"==typeof this.saveUserInfo&&this.saveUserInfo(a)):a?console.error("You are trying to save invalid user info object."):this._userInfo=null}}),a.prototype.bumpUploadLimitEnd=function(){var a=this.userInfo;return!!(a.monthEnd&&a.monthEnd<Date.now())&&(a.monthEnd+=2592e6,this.userInfo=a,!0)},a.prototype.login=function(){return this.userInfo=null,this.reload()},a.prototype.reload=function(){var e=this;return new Promise(function(f,g){var h=e.userStore,i="",j=null,k=function(b){var c=0,d=b&&b instanceof ProgressEvent&&"error"===b.type,h=b instanceof EDAMUserException,i=[EDAMErrorCode.BAD_DATA_FORMAT,EDAMErrorCode.PERMISSION_DENIED,EDAMErrorCode.DATA_REQUIRED,EDAMErrorCode.INVALID_AUTH,EDAMErrorCode.AUTH_EXPIRED,EDAMErrorCode.ACCOUNT_CLEAR];d?(e._accountIsOffline||(log.warn("Account offline"),e._accountIsOffline=!0),c=a.OFFLINE):(e._accountIsOffline&&(log.warn("Account online"),e._accountIsOffline=!1),b?(log.error(b),c=h&&i.indexOf(b.errorCode)>-1?0:a.ERROR,b.errorCode===EDAMErrorCode.ACCOUNT_CLEAR&&(Persistent.clearForUser("notebooksCache",e.userInfo.userId),e.logout()),e.userInfo=null):j&&(e.userInfo=j)),e.isAuthenticated&&(c|=a.AUTHENTICATED),e._onUpdated&&e._onUpdated.call(e,c),c&a.ERROR?g(b):f(e.userInfo)};new Promise(function(a){EDGE?chrome.cookies.getAll({url:"https://"+e.host+"/",name:"clipper-sso"},function(b){b&&b.length&&(i=(b[0].value||"").replace(/"/g,"")),a()}):a()}).then(function(){return d(h,"getUser",i)}).then(function(a){if(j=b(a),i&&j&&(j.authenticationToken=i),j&&a.businessUserInfo)return d(h,"authenticateToBusiness",i).then(function(a){a&&(e._isBusinessAuthenticationRequired=!1,Object.assign(j,c(a)),j.isOnlyBusiness&&(j.quota=j.bizQuota,j.noteSizeMax=j.bizNoteSizeMax,j.userNoteCountMax=j.bizUserNoteCountMax,j.monthEnd=j.bizMonthEnd))}).catch(function(a){if(!(a instanceof EDAMUserException&&a.errorCode===EDAMErrorCode.BUSINESS_SECURITY_LOGIN_REQUIRED))throw a;e._isBusinessAuthenticationRequired=!0})}).then(function(){return j?d(h,"getUserUrls",i):null}).then(function(a){a&&(j.urls=JSON.parse(JSON.stringify(a))),e.userInfo=j}).then(k).catch(k)})},a.prototype.logout=function(){var b=this;return new Promise(function(c){var d="https://"+b.host+"/Logout.action";(EDGE||SAFARI)&&Browser.openTab(d);var e=new XMLHttpRequest;e.open("GET",d,!0),e.onreadystatechange=function(){if(e.readyState===this.DONE){var d=0;200===e.status?b.userInfo=null:d=0===e.status?a.OFFLINE:a.ERROR,c(d),b._onUpdated&&b._onUpdated.call(b,d)}},e.send()})},a.AUTHENTICATED=1,a.OFFLINE=2,a.ERROR=4}();