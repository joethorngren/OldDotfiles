/*! Copyright 2009-2017 Evernote Corporation. All rights reserved. */

define(["GlobalUtils","isTest"],function(a,b){"use strict";function c(b,c,d){d=d||a.ACCOUNT_TYPE_PERSONAL;var e,f,g,h={};return new Promise(function(i,j){function k(c,k){if(c){if(c.debugInfo&&delete c.debugInfo,"smartFiling"===options.get("notebookSelection")&&c.notebook&&(h.smartNotebook=c.notebook),options.get("smartFilingTags")&&c.tags&&(h.smartTags=[],c.tags.list.forEach(function(a){h.smartTags.push(a.name)})),b.pendingNoteKey){if(g.relatedNotes||(g.relatedNotes={}),g.relatedNotes=c&&c.relatedNotes?c.relatedNotes.list:[],d===a.ACCOUNT_TYPE_BUSINESS&&c.containingNotebooks&&c.containingNotebooks.list.length){for(var l={},m=0;m<c.containingNotebooks.list.length;m++){var n=c.containingNotebooks.list[m];l[n.guid]={joined:n.hasSharedNotebook,name:n.notebookDisplayName,contact:n.contactName}}g.relatedNotes.containingNotebooks=l}g.info=h,f.sfCache[e]=g,extension.setPendingNote(b.pendingNoteKey,f)}i(g)}else log.error(k),j(k)}if(e=c.userId+d,b.pendingNoteKey){if(f=extension.getPendingNote(b.pendingNoteKey)||{},f.sfCache=f.sfCache||{},f.sfCache[e])return void i(f.sfCache[e]);g={}}var l=new JsonRpc(["NoteStoreExtra.getFilingRecommendations"],extension.getBaseUrl()),m=c.authenticationToken,n=c.shardId;d===a.ACCOUNT_TYPE_BUSINESS&&(m=c.bizAuthenticationToken,n=c.bizShardId),l.initWithShardId(n,function(){var a={relatedNotesResultSpec:{includeAttributes:!0,includeNotebookGuid:!0,includeTitle:!0,includeUpdated:!0},text:b.text,url:b.url};JsonQueue.handleExpensiveOpRequest({shardId:n,userId:c.userId,type:d},l.client.NoteStoreExtra.getFilingRecommendations,k,m,a)})})}function d(a,b,d){var e=accountManager.currentUserInfo;a.userId!==e.userId?(log.error("Tried to get smartfiling info for account which was not current - not supported!"),d()):c({text:a.text,url:a.url,pendingNoteKey:a.pendingNoteKey},e,a.selectedSubpart).then(function(a){b(a)}).catch(function(a){d(a)})}function e(a,b,c){var d={},e=(accountManager.currentUserInfo,Persistent.getForUser("recentNotebook",a.userId)||{});e=e[a.selectedSubpart],"lastUsed"===options.get("notebookSelection")&&e?d.preferredNotebook=e:"alwaysStartIn"===options.get("notebookSelection")&&options.get("startNotebook")&&(d.preferredNotebook=options.get("startNotebook"));options.get("alwaysTagWith")&&(d.alwaysTags=options.get("alwaysTags").split(/\s*,\s*/)),b(d)}function f(a,b,c){a.userId!==accountManager.currentId&&log.warn("requsted personal notebooks for non-current user");var d=accountManager.findAccount(a.userId),e=d.userInfo,f=Persistent.getForUser("notebooksCache",e.userId)||{};(!f.version||f.version<s)&&(f={version:s}),f.notebooks=f.notebooks||{},f.notebooks.business=f.notebooks.business||[],f.notebooks.personal=f.notebooks.personal||[],f.notebooks.linked=f.notebooks.linked||[];var k=f.notebooks.personal.length||f.notebooks.business.length;a.cached&&k&&b({personal:f.notebooks.personal,business:f.notebooks.business,linked:f.notebooks.linked}),f.updateCounts=f.updateCounts||{},d.reload().then(function(d){Promise.all([h(d,f.notebooks.personal,f.updateCounts.personal),i(d,f.notebooks.business,f.updateCounts.business),j(d)]).then(function(c){f.updateCounts.personal=c[0].USN,f.updateCounts.business=c[1].USN,f.notebooks.linked=c[2],Object.keys(f.notebooks).forEach(function(a){f.notebooks[a]=g(f.notebooks[a])}),Persistent.setForUser("notebooksCache",d.userId,f),a.cached&&k||b({personal:f.notebooks.personal,business:f.notebooks.business,linked:f.notebooks.linked})}).catch(function(b){a.cached?(log.error("Unable to update notebooks in the background"),log.error(b)):c(b)})})}function g(a){for(var b={},c=[],d=0;d<a.length;d++)b[a[d].guid]||(b[a[d].guid]=!0,c.push(a[d]));return c}function h(a,b,c){c=c||0;var d=extension.createNoteStoreClientFromUrl(a.urls.noteStoreUrl);return new Promise(function(e,f){function g(a){l(a,"getPersonalNotebooks",f)}function h(a){a.notebooks&&a.notebooks.forEach(function(a){a.shared=a.sharedNotebooks&&a.sharedNotebooks.length,n(a,b)}),a.expungedNotebooks&&a.expungedNotebooks.forEach(function(a){m(a,b)}),c=a.chunkHighUSN,a.updateCount===c?e({notebooks:b,USN:c}):(i[1]=c,d.getFilteredSyncChunk.apply(d,i))}var i=[a.authenticationToken,c,t,new SyncChunkFilter({includeExpunged:!!c,includeNotebooks:!0}),h,g];d.getFilteredSyncChunk.apply(d,i)})}function i(b,c,d){if(d=d||0,!b.bizAuthenticationToken)return Promise.resolve(c);var e=extension.createNoteStoreClientFromUrl(b.bizUrls.noteStoreUrl);return new Promise(function(f,g){function h(a){l(a,"getBusinessNotebooks",g)}function i(g){g.notebooks&&g.notebooks.forEach(function(d){d.restrictions.noCreateNotes||n({guid:d.guid,name:d.name,noShareNotes:d.restrictions.noShareNotes,owner:d.contact.id!==b.userId?d.contact.name||d.contact.username:null,shared:d.sharedNotebooks&&d.sharedNotebooks.length>1,shardId:b.bizShardId,stack:d.stack,type:a.NOTEBOOK_TYPE_BUSINESS,defaultNotebook:d.recipientSettings.recipientStatus===RecipientStatus.IN_MY_LIST_AND_DEFAULT_NOTEBOOK,published:d.published},c)}),g.expungedNotebooks&&g.expungedNotebooks.forEach(function(a){m(a,c)}),d=g.chunkHighUSN,g.updateCount===d?f({notebooks:c,USN:d}):(j[1]=d,e.getFilteredSyncChunk.apply(e,j))}var j=[b.bizAuthenticationToken,d,t,new SyncChunkFilter({includeExpunged:!!d,includeNotebooks:!0}),i,h];e.getFilteredSyncChunk.apply(e,j)})}function j(b){var c=extension.createNoteStoreClientFromUrl(b.urls.noteStoreUrl),d={};return a.promisify(c,"listLinkedNotebooks",[b.authenticationToken]).then(function(a){var c=a.filter(function(a){return a.businessId!==b.businessId&&a.sharedNotebookGlobalId&&a.noteStoreUrl});return Promise.all(c.map(function(a){return d[a.shardId]||(d[a.shardId]=extension.createNoteStoreClientFromUrl(a.noteStoreUrl)),o(a,d[a.shardId],b)}))}).then(function(a){return a.filter(function(a){return!!a.guid})})}function k(a){var b=Browser.i18n.getMessage("Error_Update_Notebooks");return 1!=a.isTrusted&&!1!==navigator.onLine||(b=Browser.i18n.getMessage("Error_Network_Unavailable")),b}function l(a,b,c){log.error("SyncChunkFailure in "+b),log.error(a),a instanceof EDAMUserException&&a.errorCode===EDAMErrorCode.PERMISSION_DENIED&&"Business"===a.parameter&&account.reload().then(function(a){a.bizAuthenticationToken&&log.error("got error that user was not in business, but still got business token here")}),c({exception:k(a)})}function m(a,b){if(b&&b.findIndex){var c=b.findIndex(function(b){return b.guid===a});return c>-1&&(b.splice(c,1),!0)}throw new Error("Error in removeNotebookFromList - list is not an Array, but "+typeof b)}function n(a,b){if(!b||!b.findIndex)throw new Error("Error in addNotebookToList - list is not an Array, but "+typeof b);var c=b.findIndex(function(b){return b.guid===a.guid});c>-1?b[c]=a:b.push(a)}function o(b,c,d){var e="";return a.promisify(c,"authenticateToSharedNotebook",[b.sharedNotebookGlobalId,d.authenticationToken]).then(function(d){if(d.authenticationToken)return e=d,a.promisify(c,"getSharedNotebookByAuth",[e.authenticationToken]);throw new Error("Unable to obtain auth token to notebook "+b.name)}).then(function(b){return a.promisify(c,"getNotebook",[e.authenticationToken,b.notebookGuid])}).then(function(c){var d=c.contact||e.user||e.publicUserInfo;return c.restrictions.noCreateNotes?{}:{globalId:b.sharedNotebookGlobalId,guid:c.guid,name:b.shareName,noShareNotes:c.restrictions.noShareNotes,owner:d.name||d.username,shardId:b.shardId,noteStoreUrl:b.noteStoreUrl,stack:b.stack,type:a.NOTEBOOK_TYPE_LINKED,shared:!0}}).catch(function(a){return log.error("Unable to access linked notebook "+b.name),log.error(a),{}})}function p(b,c,d){b.userId!==accountManager.currentId&&log.warn("requested tags for non-current user");var e,f,g=accountManager.findAccount(b.userId),h=g.userInfo;b.selectedSubpart===a.ACCOUNT_TYPE_PERSONAL?(e=h.authenticationToken,f=extension.createNoteStoreClientFromUrl(h.urls.noteStoreUrl)):(e=h.bizAuthenticationToken,f=extension.createNoteStoreClientFromUrl(h.bizUrls.noteStoreUrl)),a.promisify(f,"listTags",[e]).then(function(a){c(a)}).catch(function(a){log.error("Error listing tags for "+b.userId+" "+b.selectedSubpart),log.error(a),c([])})}function q(b,c,d){function e(a){var b=Browser.i18n.getMessage("Error_Create_Notebook");if(1==a.isTrusted||!1===navigator.onLine)return Browser.i18n.getMessage("Error_Network_Unavailable");switch(a.errorCode){case 2:switch(a.parameter){case"Notebook.name":b=Browser.i18n.getMessage("Error_Create_Notebook_InvalidName")}break;case 5:break;case 10:switch(a.parameter){case"Notebook.name":b=Browser.i18n.getMessage("Error_Create_Notebook_ExistingName")}break;case 6:switch(a.parameter){case"Notebook":b=Browser.i18n.getMessage("Error_Create_Notebook_QuotaReached")}}return b}accountManager.reloadCurrent().then(function(f){var g,h,i,j=b.notebook;j.personalNotebook?(g=extension.createNoteStoreClient(),h=f.authenticationToken):f.bizAuthenticationToken?(g=extension.createBusinessNoteStoreClient(),h=f.bizAuthenticationToken,i=f.authenticationToken):(log.error("Requested to create business notebook, but there was no business token."),d(Browser.i18n.getMessage("Error_Create_Notebook")));var k=new Notebook({name:j.name});a.promisify(g,"createNotebook",[h,k]).then(function(b){if(b.errorCode||!b.guid)log.error("Error creating notebook "+j.name),log.error(b),d(e(b));else if(j.personalNotebook)c({guid:b.guid,name:b.name,shardId:f.shardId,type:a.NOTEBOOK_TYPE_PERSONAL});else{var h=b.guid,k=new LinkedNotebook({shardId:f.bizShardId,sharedNotebookGlobalId:b.sharedNotebooks[0].globalId,shareName:b.name,username:f.bizUserName});a.promisify(g,"createLinkedNotebook",[i,k]).then(function(b){b.errorCode||!b.guid?(log.error("Error linking business notebook "+j.name),log.error(b),d(e(b))):c({guid:h,name:b.shareName,shardId:f.bizShardId,type:a.NOTEBOOK_TYPE_BUSINESS})})}}).catch(function(a){log.error("Generic error creating notebook "+JSON.stringify(b)),log.error(a),d(Browser.i18n.getMessage("Error_Create_Notebook"))})})}var r={},s=2,t=50;return platform.channel.registerHandlers({getNotebooks:f,getTags:p,createNotebook:q,getFilingInfo:e,getSmartFilingInfo:d}),r.getSmartFilingInfo=c,r});